<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FUZZY Analytical Hierarchy</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="header-box">
      <h1>FUZZY Analytical Hierarchy</h1>
    </div>
    <div class="main-container">
      <div class="content-body">
        <div class="sidebar">
          <h2>Steps of FAHP</h2>
          <ul id="fahp-steps">
            <li id="step1">
              <div class="step-container">
                <span class="circle" id="circle1">1</span>
                <span>Step 1: Set Goal</span>
              </div>
              <div class="progress-bar" id="progress-bar1"></div>
            </li>
            <li id="step2">
              <div class="step-container">
                <span class="circle" id="circle2">2</span>
                <span>Step 2: Pairwise Comparison</span>
              </div>
              <div class="progress-bar" id="progress-bar2"></div>
            </li>
            <li id="step3">
              <div class="step-container">
                <span class="circle" id="circle3">3</span>
                <span>Step 3: Fuzzy Synthetic Extent</span>
              </div>
              <div class="progress-bar" id="progress-bar3"></div>
            </li>
            <li id="step4">
              <div class="step-container">
                <span class="circle" id="circle4">4</span>
                <span>Step 4: Priority Weights Calculation</span>
              </div>
              <div class="progress-bar" id="progress-bar4"></div>
            </li>
          </ul>
        </div>
        <div class="content">
          <div class="upload-section">
            <label for="file-input">Choose the dataset:</label>
            <input
              type="file"
              name="file"
              class="upload-input"
              id="file-input"
              required
            />
            <button type="button" class="upload-btn" id="upload-btn">
              Upload
            </button>
          </div>
          <div class="criteria-section">
            <h2>Select Criteria and Weights</h2>
            <div id="criteria-container"></div>
            <button type="button" id="add-criteria-btn" disabled>
              + Add More Criteria
            </button>
            <button type="button" id="add-custum-criteria-btn" disabled>
              + Add Custom Criteria
            </button>
            <br />
            <button
              type="button"
              id="confirm-criteria-btn"
              class="confirm-btn"
              style="margin-top: 10px"
              disabled
            >
              Confirm Criteria and Weights
            </button>
          </div>
          <div class="run-section">
            <button id="run-btn" class="run-btn" disabled>Run</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const defaultCriteria = [
        "Throughput",
        "Latency",
        "Response Time",
        "Network Load",
      ];
      const weightOptions = [
        "Equally Important",
        "Moderately Important",
        "Strongly Important",
      ];

      function createCriteriaRow(customCriteria = null) {
        const row = document.createElement("div");
        row.className = "criteria-row";

        const criteriaSelect = document.createElement("select");
        criteriaSelect.className = "criteria-select";

        // Add the default criteria options
        defaultCriteria.forEach((criteria) => {
          const option = document.createElement("option");
          option.value = criteria.toLowerCase().replace(/\s+/g, "_");
          option.textContent = criteria;
          criteriaSelect.appendChild(option);
        });

        // If custom criteria is provided, add it and select it
        if (customCriteria && typeof customCriteria === "string") {
          const customOption = document.createElement("option");
          customOption.value = customCriteria
            .toLowerCase()
            .replace(/\s+/g, "_");
          customOption.textContent = customCriteria;
          customOption.selected = true;
          criteriaSelect.appendChild(customOption);
        } else {
          // Select the first unused default criteria
          const unusedCriteria = getUnusedDefaultCriteria();
          if (unusedCriteria) {
            criteriaSelect.value = unusedCriteria
              .toLowerCase()
              .replace(/\s+/g, "_");
          }
        }

        criteriaSelect.addEventListener("change", updateCriteriaOptions);

        const weightSelect = document.createElement("select");
        weightSelect.className = "weight-select";
        weightOptions.forEach((weight) => {
          const option = document.createElement("option");
          option.value = weight.toLowerCase().replace(/\s+/g, "_");
          option.textContent = weight;
          weightSelect.appendChild(option);
        });

        const removeBtn = document.createElement("button");
        removeBtn.textContent = "Remove";
        removeBtn.className = "remove-btn";
        removeBtn.onclick = function () {
          row.remove();
          updateCriteriaOptions();
        };

        const selectContainer = document.createElement("div");
        selectContainer.className = "select-container";
        selectContainer.appendChild(document.createTextNode("Criteria: "));
        selectContainer.appendChild(criteriaSelect);
        selectContainer.appendChild(document.createTextNode("Weight: "));
        selectContainer.appendChild(weightSelect);

        row.appendChild(selectContainer);

        const buttonContainer = document.createElement("div");
        buttonContainer.className = "button-container";
        buttonContainer.appendChild(removeBtn);
        row.appendChild(buttonContainer);

        return row;
      }

      function addCriteriaRow(customCriteria = null) {
        const container = document.getElementById("criteria-container");
        const unusedCriteria = getUnusedDefaultCriteria();

        // Only allow adding if there are unused default criteria or custom criteria provided
        if (customCriteria || unusedCriteria) {
          const row = createCriteriaRow(customCriteria);
          container.appendChild(row);
          updateCriteriaOptions();
        } else {
          alert(
            "All default criteria are already selected. Consider adding a custom criterion."
          );
        }
      }

      function addCustomCriteria() {
        const customCriteria = prompt(
          "Please enter the name of the custom criteria:"
        );
        if (customCriteria && customCriteria.trim() !== "") {
          const sanitizedCustomCriteria = customCriteria
            .toLowerCase()
            .replace(/\s+/g, "_");
          // Check if this custom criteria already exists in the list or among selected options
          const existingCriteria = defaultCriteria.map((c) =>
            c.toLowerCase().replace(/\s+/g, "_")
          );
          const selectedCriteria = Array.from(
            document.querySelectorAll(".criteria-select")
          ).map((select) => select.value);

          if (
            existingCriteria.includes(sanitizedCustomCriteria) ||
            selectedCriteria.includes(sanitizedCustomCriteria)
          ) {
            alert(
              "This custom criterion name is already taken. Please try a different name."
            );
            return;
          }

          // Add to the default list and then add it to the form
          defaultCriteria.push(customCriteria);
          addCriteriaRow(customCriteria);
        } else {
          alert("Invalid criteria name. Please try again.");
        }
      }

      function updateCriteriaOptions() {
        const selectedCriteria = Array.from(
          document.querySelectorAll(".criteria-select")
        ).map((select) => select.value);

        // Disable selected options across all dropdowns
        document.querySelectorAll(".criteria-select").forEach((select) => {
          Array.from(select.options).forEach((option) => {
            option.disabled =
              selectedCriteria.includes(option.value) && !option.selected;
          });
        });

        // Enable or disable the "Add More Criteria" button
        const addMoreBtn = document.getElementById("add-criteria-btn");
        if (getUnusedDefaultCriteria()) {
          addMoreBtn.disabled = false;
        } else {
          addMoreBtn.disabled = true;
        }
      }

      function getUnusedDefaultCriteria() {
        const selectedCriteria = Array.from(
          document.querySelectorAll(".criteria-select")
        ).map((select) => select.value);

        return defaultCriteria.find(
          (criteria) =>
            !selectedCriteria.includes(
              criteria.toLowerCase().replace(/\s+/g, "_")
            )
        );
      }

      function updateStepProgress(step) {
        document.getElementById(`progress-bar${step}`).style.width = "100%";
        document
          .getElementById(`progress-bar${step}`)
          .classList.add("green-bar");
        document.getElementById(`circle${step}`).classList.add("completed");
        document.getElementById(`circle${step}`).textContent = "âœ“";
      }

      document
        .getElementById("upload-btn")
        .addEventListener("click", function () {
          var fileInput = document.getElementById("file-input").files[0];
          if (fileInput) {
            var formData = new FormData();
            formData.append("file", fileInput);

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/", true);
            xhr.onload = function () {
              if (xhr.status === 200) {
                document.getElementById("upload-btn").innerText = "Uploaded";
                document.getElementById("upload-btn").style.backgroundColor =
                  "#00a2ff";
                document.getElementById("upload-btn").disabled = true;
                document.getElementById("file-input").disabled = true;
                document.getElementById("add-criteria-btn").disabled = false;
                document.getElementById(
                  "add-custum-criteria-btn"
                ).disabled = false;
                document.getElementById(
                  "confirm-criteria-btn"
                ).disabled = false;
                addCriteriaRow();
                updateStepProgress(1);
              } else {
                alert("Error uploading file.");
              }
            };
            xhr.send(formData);
          } else {
            alert("Please choose a file to upload.");
          }
        });

      document
        .getElementById("add-criteria-btn")
        .addEventListener("click", addCriteriaRow);
      document
        .getElementById("add-custum-criteria-btn")
        .addEventListener("click", addCustomCriteria);

      document
        .getElementById("confirm-criteria-btn")
        .addEventListener("click", function () {
          updateStepProgress(2);
          updateStepProgress(3);
          this.disabled = true;
          document.getElementById("add-criteria-btn").disabled = true;
          document.getElementById("add-custum-criteria-btn").disabled = true;
          document
            .querySelectorAll(".criteria-select, .weight-select, .remove-btn")
            .forEach((el) => (el.disabled = true));
          document.getElementById("run-btn").disabled = false;
        });

      document.getElementById("run-btn").addEventListener("click", function () {
        var fileInput = document.getElementById("file-input").files[0];
        var criteriaAndWeights = Array.from(
          document.querySelectorAll(".criteria-row")
        ).map((row) => ({
          criteria: row.querySelector(".criteria-select").value,
          weight: row.querySelector(".weight-select").value,
        }));

        if (fileInput && criteriaAndWeights.length > 0) {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", "/run_fahp", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onload = function () {
            if (xhr.status === 200) {
              var response = JSON.parse(xhr.responseText);
              if (response.success) {
                updateStepProgress(3);
                updateStepProgress(4);
                window.location.href = `/results?priority_weights=${response.priority_weights}&results_path=${response.results_path}&graph_path=${response.graph_path}`;
              }
            } else {
              alert("Error running FAHP process.");
            }
          };
          xhr.send(
            JSON.stringify({
              filename: fileInput.name,
              criteria_and_weights: criteriaAndWeights,
            })
          );
        } else {
          alert(
            "Please ensure that a file is uploaded and at least one criteria is selected."
          );
        }
      });
    </script>
  </body>
</html>
